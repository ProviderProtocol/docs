---
title: Conformance
description: Provider conformance levels and requirements.
---

import { Aside, Badge, Card, CardGrid } from '@astrojs/starlight/components';

# Conformance

<Badge text="UPP-1.2.0" variant="note" />

## Provider Conformance Levels

Providers may implement one or more modalities. For each modality, conformance is defined at multiple levels.

#### 16.1.1 LLM Conformance

**Level 1: Core (Required)**
- Declare `LLMCapabilities` accurately for the provider's API
- Text input/output via `complete()` method
- Return `LLMResponse` with `AssistantMessage` and `TokenUsage`
- Basic configuration pass-through (`params`)
- Error normalization to `UPPError` with correct `modality: "llm"`
- System prompt handling per vendor requirements

**Level 2: Streaming** (`capabilities.streaming: true`)
- `stream()` method implementation
- Proper `StreamEvent` emission with correct `StreamEventType`
- `LLMStreamResult` with `response` promise
- Support for `message_start`, `text_delta`, `message_stop` at minimum

**Level 3: Tools** (`capabilities.tools: true`)
- Tool definition transformation (JSON Schema to vendor format)
- Tool call detection in responses (`AssistantMessage.toolCalls`)
- Tool result handling (`ToolResultMessage` transformation)
- Note: Tool execution loop is handled by `llm()` core, not providers

**Level 4: Structured Output** (`capabilities.structuredOutput: true`)
- Transform `structure` schema to vendor format
- Enable vendor's structured output mode
- Parse and return structured data as JSON

**Level 5: Multimodal Input** (`capabilities.imageInput`, `documentInput`, `videoInput`, `audioInput`)
- Image input handling (base64, URL conversion) if `imageInput: true`
- Document input handling (PDF base64, PDF URL, plain text) if `documentInput: true`
- Video input handling if `videoInput: true`
- Audio input handling if `audioInput: true`

#### 16.1.2 Embedding Conformance

**Level 1: Core (Required)**
- `embed()` method handling batch requests
- Return `EmbeddingResponse` with vectors, usage, and metadata
- Text input support
- Error normalization with `modality: "embedding"`
- Respect `maxBatchSize` limits
- Pass provider-specific params through unchanged

**Level 2: Metadata Preservation**
- Preserve per-embedding metadata (e.g., truncation status, token counts)
- Preserve response-level metadata (e.g., safety ratings)
- Return `vector` as floats or base64 string (core normalizes)

**Level 3: Multimodal**
- Image embedding support (if vendor supports)
- Declare supported inputs in `supportedInputs`

#### 16.1.3 Image Conformance

**Level 1: Core (Required)**
- `generate()` method for text-to-image
- Return `ImageResponse` with `GeneratedImage` array
- Declare capabilities in `ImageCapabilities`
- Error normalization with `modality: "image"`

**Level 2: Editing**
- `edit()` method for inpainting (if `capabilities.edit`)
- Mask handling

**Level 3: Streaming**
- `stream()` method (if `capabilities.streaming`)
- Preview events

## Conformance Requirements

#### 16.2.1 Error Handling

All providers MUST:
- Normalize vendor errors to `UPPError`
- Set appropriate `ErrorCode` based on HTTP status or vendor error type
- Include `provider` name and `modality` in all errors
- Preserve original error as `cause` when available

**HTTP Status Code Mapping:**

| HTTP Status | UPP Error Code |
|-------------|----------------|
| 400 | `INVALID_REQUEST` (or `CONTEXT_LENGTH_EXCEEDED` if indicated) |
| 401 | `AUTHENTICATION_FAILED` |
| 403 | `AUTHENTICATION_FAILED` or `QUOTA_EXCEEDED` |
| 404 | `MODEL_NOT_FOUND` |
| 429 | `RATE_LIMITED` |
| 500, 502, 503 | `PROVIDER_ERROR` |

#### 16.2.2 Configuration Pass-through

All providers MUST:
- Pass `params` to vendor API without modification (unless transformation required)
- Support custom `baseUrl` for proxies
- Support custom `fetch` implementation
- Respect `timeout` setting
- Use provided `retryStrategy` or sensible default

#### 16.2.3 Metadata Handling

All providers MUST:
- Namespace their metadata under `metadata.{providerName}`
- Preserve unknown metadata fields during round-trips
- Extract vendor-specific response fields to metadata

## Interoperability Notes

The following features are provider-dependent and may not transfer between providers:

- Token counting algorithms and limits
- Specific tool calling formats and behaviors
- Streaming granularity and event types
- Response metadata structure
- Rate limiting behavior and headers
- Supported modalities and model capabilities
- Image size and format support
- Embedding dimensions and normalization

Developers should consult individual provider documentation for feature support details.

## Capability Declaration

Providers MUST accurately declare their capabilities:

- **LLMHandler**: Via `LLMCapabilities` on `BoundLLMModel`
- **EmbeddingHandler**: Declare `supportedInputs` array
- **ImageHandler**: Declare full `ImageCapabilities` object

Applications SHOULD check capabilities before using optional features to ensure graceful degradation.